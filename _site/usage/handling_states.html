<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Handling states and Logging-In - CatraProto Docs</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Handling states and Logging-In | CatraProto Docs</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="Handling states and Logging-In" /> <meta property="og:locale" content="en_US" /> <link rel="canonical" href="http://localhost:4000/usage/handling_states.html" /> <meta property="og:url" content="http://localhost:4000/usage/handling_states.html" /> <meta property="og:site_name" content="CatraProto Docs" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Handling states and Logging-In" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","headline":"Handling states and Logging-In","url":"http://localhost:4000/usage/handling_states.html"}</script> <!-- End Jekyll SEO tag --> </head> <html lang="en-US"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta charset="utf-8"> <title>Handling states and Logging-In - CatraProto Docs</title> <link rel="stylesheet" href="/assets/css/custom.css"> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> CatraProto Docs </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">Introduction</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/configuration/" class="nav-list-link">Initial configuration</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/configuration/app_configuration.html" class="nav-list-link">App Configuration</a></li><li class="nav-list-item "><a href="http://localhost:4000/configuration/library_configuration.html" class="nav-list-link">Library Configuration</a></li><li class="nav-list-item "><a href="http://localhost:4000/configuration/logger_configuration.html" class="nav-list-link">Logger Configuration</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/usage/" class="nav-list-link">Using the library</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/usage/invoking_api.html" class="nav-list-link">Calling API methods</a></li><li class="nav-list-item active"><a href="http://localhost:4000/usage/handling_states.html" class="nav-list-link active">Handling states and Logging-In</a></li><li class="nav-list-item "><a href="http://localhost:4000/usage/receiving_updates.html" class="nav-list-link">Receiving Messages (Updates)</a></li><li class="nav-list-item "><a href="http://localhost:4000/usage/init_client.html" class="nav-list-link">Library initialization</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/enhancing/" class="nav-list-link">Enhancing your experience</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/enhancing/markup.html" class="nav-list-link">Styiling text</a></li><li class="nav-list-item "><a href="http://localhost:4000/enhancing/json.html" class="nav-list-link">JSON Serialization</a></li></ul></li><li class="nav-list-item"><a href="http://localhost:4000/custom_serializer.html" class="nav-list-link">Custom session serializers</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search CatraProto Docs" aria-label="Search CatraProto Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/CatraProto/Client" class="site-button" > Source Code </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/usage/">Using the library</a></li> <li class="breadcrumb-nav-list-item"><span>Handling states and Logging-In</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="handling-state-changes-logging-in"> <a href="#handling-state-changes-logging-in" class="anchor-heading" aria-labelledby="handling-state-changes-logging-in"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling state changes (Logging-In) </h1> <p>CatraProto sends updates regarding the current session to the <code class="language-plaintext highlighter-rouge">OnSessionUpdateAsync</code> method of the <code class="language-plaintext highlighter-rouge">IEventHandler</code> interface. This means you will not just receive updates when the authorization flow changes, but also if the session becomes invalid. In the examples below, login is implemented in this method.</p> <p>This first part only covers logging in, to see what the other states mean, navigate to <a href="#handling-state-changes-other-states">other states</a>.<br /> <strong>Note:</strong> This method is invoked in a sequential-manner, this means that you won’t receive a new update until you finished processing the old one.</p> <h2 id="how-it-works"> <a href="#how-it-works" class="anchor-heading" aria-labelledby="how-it-works"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How it works </h2> <p>The way login works is pretty easy. Some methods either return <code class="language-plaintext highlighter-rouge">Task&lt;RpcError?&gt;</code> or <code class="language-plaintext highlighter-rouge">SomeValue?</code>. In the first case, null is returned when no error has occured, in the second case null is returned when the operation could not be performed (check the logs).<br /> The app advances state (i.e from asking for the phone number to asking the sms-code) when the corresponding update is received.</p> <p>If <code class="language-plaintext highlighter-rouge">receivedState &gt;= LoginState.LoggedOut</code> the app must close the instance, delete the session file and create a new instance, because the session is now invalid.</p> <h2 id="handling-errors"> <a href="#handling-errors" class="anchor-heading" aria-labelledby="handling-errors"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling errors </h2> <p>Some errors are recoverable, which means you can just re-try the query with different parameters.<br /> The only recoverable errors are:</p> <ul> <li><code class="language-plaintext highlighter-rouge">PhoneCodeIncorrectError</code> which is returned when the provided phone code was entered incorrectly.</li> <li><code class="language-plaintext highlighter-rouge">PasswordIncorrectError</code> which is returned when the provided password was entered incorrectly.</li> </ul> <p>When other errors are returned, a new state is sent to the app.<br /> Every error is supposed to be shown to the user, even if it is <code class="language-plaintext highlighter-rouge">UnknownError</code>.</p> <h2 id="restarting-the-flow"> <a href="#restarting-the-flow" class="anchor-heading" aria-labelledby="restarting-the-flow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Restarting the flow </h2> <p>Even though it is not present in these examples, if the state is not higher or equal to <code class="language-plaintext highlighter-rouge">LoggedIn</code> you can call <code class="language-plaintext highlighter-rouge">CancelAsync()</code> to cancel the current operation.<br /> This method does not return cannot return errors. As always, you will receive a new state.</p> <h2 id="example-of-user-login"> <a href="#example-of-user-login" class="anchor-heading" aria-labelledby="example-of-user-login"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example of user login </h2> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnSessionUpdateAsync</span><span class="p">(</span><span class="n">LoginState</span> <span class="n">loginState</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">RpcError</span><span class="p">?&gt;?</span> <span class="n">task</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="k">is</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">AwaitingLogin</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">char</span> <span class="n">finalChoice</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"Welcome! Would you like to login as a bot or as a user? (b/u): "</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">readLine</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">readLine</span> <span class="k">is</span> <span class="k">null</span> <span class="p">||</span> <span class="n">readLine</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="m">1</span> <span class="p">||</span> <span class="p">(</span><span class="n">readLine</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">!=</span> <span class="sc">'u'</span> <span class="p">&amp;&amp;</span> <span class="n">readLine</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">!=</span> <span class="sc">'b'</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"I'm sorry but this option is invalid"</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">finalChoice</span> <span class="p">=</span> <span class="n">readLine</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">finalChoice</span> <span class="p">==</span> <span class="sc">'u'</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"You've selected login as user. Please enter the phone number: "</span><span class="p">);</span>
            <span class="n">task</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">UsePhoneNumberAsync</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">()</span> <span class="p">??</span> <span class="s">""</span><span class="p">,</span> <span class="k">new</span> <span class="nf">CodeSettings</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"You've selected login as bot. Please enter the bot token: "</span><span class="p">);</span>
            <span class="n">task</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">UseBotTokenAsync</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">()</span> <span class="p">??</span> <span class="s">""</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="k">is</span> <span class="n">BotTokenIncorrectError</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"I'm sorry, but this token does not work. Make sure you're copying it correctly."</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="k">is</span> <span class="n">PhoneNumberIncorrectError</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"I'm sorry, but this phone number does not work. Make sure you're typing every digit correctly."</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="k">is</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">AwaitingCode</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"Please insert the login code or r to resend it: "</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">read</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="p">==</span> <span class="s">"r"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">task</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">ResendCodeAsync</span><span class="p">();</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">codeType</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">GetCodeTypes</span><span class="p">()!.</span><span class="n">Value</span><span class="p">.</span><span class="n">CodeType</span><span class="p">;</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"The code was resent successfully. Code type </span><span class="p">{</span><span class="n">codeType</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">task</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">UseLoginCodeAsync</span><span class="p">(</span><span class="n">read</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="k">is</span> <span class="n">not</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="k">is</span> <span class="n">PhoneCodeIncorrectError</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"The given phone code was invalid, try again or press r to resend it: "</span><span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="k">is</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">AwaitingTermsAcceptance</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">GetTermsOfService</span><span class="p">()!.</span><span class="n">Text</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"Great! Please accept the terms of service (y/n): "</span><span class="p">);</span>
        <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">SetTerms</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">().</span><span class="n">KeyChar</span> <span class="p">==</span> <span class="sc">'y'</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="k">is</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">AwaitingRegistration</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"It looks like this phone number is not registered."</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">||</span> <span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"What's your first name? "</span><span class="p">);</span>
            <span class="n">name</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">$"Ok </span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s">. What about your last name (Press enter to leave blank)? "</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">lastName</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">()</span> <span class="p">??</span> <span class="s">""</span><span class="p">;</span>
        <span class="n">task</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">UseProfileDataAsync</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lastName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="k">is</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">AwaitingPassword</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"Yay! Please type your 2FA password here: "</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">task</span> <span class="p">=</span> <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">UsePasswordAsync</span><span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">()</span> <span class="p">??</span> <span class="s">""</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">error</span> <span class="p">=</span> <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="k">is</span> <span class="n">not</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="k">is</span> <span class="n">PasswordIncorrectError</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Oops! The password is incorrect. Please try again."</span><span class="p">);</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="k">is</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">LoggedIn</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">getSelf</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_client</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">CloudChatsApi</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="nf">GetSelfAsync</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">getSelf</span><span class="p">.</span><span class="n">RpcCallFailed</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Something went wrong and I could not fetch the bot's profile. Error </span><span class="p">{</span><span class="n">getSelf</span><span class="p">.</span><span class="n">Error</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Wow! We are logged in! We are: </span><span class="p">{</span><span class="n">getSelf</span><span class="p">.</span><span class="n">Response</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="p">&gt;=</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">LoggedOut</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Hey! The session is dead. I received the following state: </span><span class="p">{</span><span class="n">loginState</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="k">is</span> <span class="n">not</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="k">is</span> <span class="n">not</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"I'm sorry, the following error occurred while logging in </span><span class="p">{</span><span class="n">result</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>Please note that if you use <code class="language-plaintext highlighter-rouge">Console.ReadLine</code> to prevent the app from quitting, you’ll need to do it in another way or to call it only when the login is finished. The latter is done in the <a href="https://github.com/CatraProto/Client/example/ConsoleLogin">full example</a> using a <code class="language-plaintext highlighter-rouge">TaskCompletionSource</code>.</strong></p> <h3 id="code-explaination"> <a href="#code-explaination" class="anchor-heading" aria-labelledby="code-explaination"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code explaination </h3> <p>Even if at first sight this might look very complex and hard to understand, this explaination will try to make it as simple as possible. Remember that each time an API call is made, it is assigned to the <code class="language-plaintext highlighter-rouge">task</code> variable so that at the end of the method, it will be awaited and the error, if present, will be shown to the user.</p> <ul> <li> <p>When the state is <em>AwaitingLogin</em>, the app keeps asking the user whether they want to login as a user or as a bot until a a valid answer is received.<br /> If they choose to login as a user, the app will ask for a phone number, if they choose to login as a bot the app will ask for a bot token.<br /> The app awaits the API call to see if an error occurred, and if it is one of the known login-related errors it will show a better message to the user.</p> </li> <li> <p>When the state is <em>AwaitingPhoneCode</em>, the app sent the phone code to the user and keeps asking the user whether they want to try a code or to resend it, until no error is returned or another error (such as flood wait) is received.</p> </li> <li> <p>When the state is <em>AwaitingPassword</em>, the account is protected by 2FA (Two-Factor Authentication) and the app keeps asking the user for a valid password until login succeeds or an error different from <code class="language-plaintext highlighter-rouge">PasswordIncorrectError</code> from is returned.</p> </li> <li> <p>When the state is <em>AwaitingTermsAcceptance</em> the app shows the user the terms of service and asks the user whether they accept them or not.</p> </li> <li> <p>When the state is <em>AwaitingRegistration</em> the app asks the user for a first name and a last name (optionally) to register the user to Telegram.</p> </li> <li> <p>When the state is <em>LoggedIn</em>, the app calls <code class="language-plaintext highlighter-rouge">GetSelfAsync</code> to retrieve information about the bot and logs it in json-format. The app also checks whether the API call received an error, because the session could have been terminated while we were still handling this update.</p> </li> <li> <p>When the state is &gt;= <em>LoggedOut</em>, the app will simply let the user know that it has changed (i.e. the session was terminated and <em>SESSION_REVOKED</em> was received).</p> </li> </ul> <h2 id="example-of-bot-login"> <a href="#example-of-bot-login" class="anchor-heading" aria-labelledby="example-of-bot-login"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example of bot login </h2> <p>This is what handling a bot session from a simple console app looks like:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnSessionUpdateAsync</span><span class="p">(</span><span class="n">LoginState</span> <span class="n">loginState</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="k">is</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">AwaitingLogin</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">r</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_client</span><span class="p">.</span><span class="n">LoginManager</span><span class="p">.</span><span class="nf">UseBotTokenAsync</span><span class="p">(</span><span class="s">"5525446665:AAH95cataglrak0Mpro9Awto4gud0zbUM"</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="k">is</span> <span class="n">not</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Could not login, the following error occurred: </span><span class="p">{</span><span class="n">r</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="k">is</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">LoggedIn</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">getSelf</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_client</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">CloudChatsApi</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="nf">GetSelfAsync</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">getSelf</span><span class="p">.</span><span class="n">RpcCallFailed</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Something went wrong and I could not fetch the bot's profile. Error </span><span class="p">{</span><span class="n">getSelf</span><span class="p">.</span><span class="n">Error</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"We are logged-in as </span><span class="p">{</span><span class="n">r</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">ToJson</span><span class="p">()}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loginState</span> <span class="p">&gt;=</span> <span class="n">LoginState</span><span class="p">.</span><span class="n">LoggedOut</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Received state </span><span class="p">{</span><span class="n">loginState</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="code-explaination-1"> <a href="#code-explaination-1" class="anchor-heading" aria-labelledby="code-explaination-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Code explaination </h3> <p>The code is pretty simple, each time the state changes <code class="language-plaintext highlighter-rouge">OnSessionUpdateAsync</code> is invoked and the app checks whether the state is <em>AwaitingLogin</em>, <em>LoggedIn</em> or something else.</p> <ul> <li>When the state is <em>AwaitingLogin</em>, the app tries to login using the bot token provided in the first parameter of the UseBotTokenAsync method, if an error is returned, it is logged to the user otherwise the app waits until it receives a new state.</li> <li>When the state is <em>LoggedIn</em>, the app calls <code class="language-plaintext highlighter-rouge">GetSelfAsync</code> to retrieve information about the bot and logs it in json-format. The app also checks whether the API call received an error, because the session could have been terminated while we were still handling this update.</li> <li>When the state is &gt;= <em>LoggedOut</em>, the app will simply let the user know that it has changed (i.e. the session was terminated and <em>SESSION_REVOKED</em> was received).</li> </ul> <h1 id="handling-state-changes-other-states"> <a href="#handling-state-changes-other-states" class="anchor-heading" aria-labelledby="handling-state-changes-other-states"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Handling state changes (Other states) </h1> <p>Other states that are not directly related to the login flow are the following:</p> <ul> <li>LoggedOut - When log out is done by calling <code class="language-plaintext highlighter-rouge">LoginManager.LogoutAsync()</code></li> <li>SessionRevoked - When the session was revoked from another device</li> <li>AccountBanned - When the account was banned by Telegram</li> <li>AccountDeactivated - When the user deactivated their account</li> <li>KeyDuplicated - When the same session was used at the same time (i.e same session file on two different servers)</li> </ul> <p>Once those are received, the session cannot be used anymore and you will need to create a new session file or wipe the current one. Before doing so, remember to <code class="language-plaintext highlighter-rouge">DisposeAsync()</code> the current <code class="language-plaintext highlighter-rouge">TelegramClient</code> instance.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
