<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Receiving Messages (Updates) - CatraProto Docs</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Receiving Messages (Updates) | CatraProto Docs</title> <meta name="generator" content="Jekyll v4.2.2" /> <meta property="og:title" content="Receiving Messages (Updates)" /> <meta property="og:locale" content="en_US" /> <link rel="canonical" href="http://localhost:4000/usage/receiving_updates.html" /> <meta property="og:url" content="http://localhost:4000/usage/receiving_updates.html" /> <meta property="og:site_name" content="CatraProto Docs" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Receiving Messages (Updates)" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","headline":"Receiving Messages (Updates)","url":"http://localhost:4000/usage/receiving_updates.html"}</script> <!-- End Jekyll SEO tag --> </head> <html lang="en-US"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta charset="utf-8"> <title>Receiving Messages (Updates) - CatraProto Docs</title> <link rel="stylesheet" href="/assets/css/custom.css"> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/" class="site-title lh-tight"> CatraProto Docs </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">Introduction</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/configuration/" class="nav-list-link">Initial configuration</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/configuration/app_configuration.html" class="nav-list-link">App Configuration</a></li><li class="nav-list-item "><a href="http://localhost:4000/configuration/library_configuration.html" class="nav-list-link">Library Configuration</a></li><li class="nav-list-item "><a href="http://localhost:4000/configuration/logger_configuration.html" class="nav-list-link">Logger Configuration</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/usage/" class="nav-list-link">Using the library</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/usage/invoking_api.html" class="nav-list-link">Calling API methods</a></li><li class="nav-list-item "><a href="http://localhost:4000/usage/handling_states.html" class="nav-list-link">Handling states and Logging-In</a></li><li class="nav-list-item active"><a href="http://localhost:4000/usage/receiving_updates.html" class="nav-list-link active">Receiving Messages (Updates)</a></li><li class="nav-list-item "><a href="http://localhost:4000/usage/init_client.html" class="nav-list-link">Library initialization</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/enhancing/" class="nav-list-link">Enhancing your experience</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/enhancing/markup.html" class="nav-list-link">Styiling text</a></li><li class="nav-list-item "><a href="http://localhost:4000/enhancing/json.html" class="nav-list-link">JSON Serialization</a></li></ul></li><li class="nav-list-item"><a href="http://localhost:4000/custom_serializer.html" class="nav-list-link">Custom session serializers</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search CatraProto Docs" aria-label="Search CatraProto Docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/CatraProto/Client" class="site-button" > Source Code </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/usage/">Using the library</a></li> <li class="breadcrumb-nav-list-item"><span>Receiving Messages (Updates)</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="receiving-updates"> <a href="#receiving-updates" class="anchor-heading" aria-labelledby="receiving-updates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Receiving Updates </h1> <p>Receiving messages means in fact <strong>receiving an update</strong>. Updates <strong>do not only communicate whether a new message was sent, edited or received but many, many other things</strong> such as a user typing or <strong>in the case of bots</strong> when a user’s permissions in a chat have changed.</p> <p><strong>CatraProto takes care of the correct handling of updates so you don’t have to make sure there are no gaps or duplicate updates</strong>.</p> <h2 id="creating-an-eventhandler"> <a href="#creating-an-eventhandler" class="anchor-heading" aria-labelledby="creating-an-eventhandler"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Creating an EventHandler </h2> <p>To handle updates a class extending the <a href="https://github.com/CatraProto/Client/blob/master/src/CatraProto.Client/Updates/Interfaces/IEventHandler.cs">IEventHandler</a> interface must be defined.</p> <p>Example:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">EventHandler</span> <span class="p">:</span> <span class="n">IEventHandler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">TelegramClient</span> <span class="n">_client</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">EventHandler</span><span class="p">(</span><span class="n">TelegramClient</span> <span class="n">client</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_client</span> <span class="p">=</span> <span class="n">client</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnSessionUpdateAsync</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//login code from the previous page goes here</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnUpdateAsync</span><span class="p">(</span><span class="n">UpdateBase</span> <span class="n">update</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">update</span> <span class="k">is</span> <span class="n">UpdateNewMessage</span> <span class="p">{</span> <span class="n">Message</span><span class="p">:</span> <span class="n">Message</span> <span class="p">{</span> <span class="n">Out</span><span class="p">:</span> <span class="k">false</span> <span class="p">}</span> <span class="n">message</span> <span class="p">})</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">asPeerId</span> <span class="p">=</span> <span class="n">PeerId</span><span class="p">.</span><span class="nf">FromPeer</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">PeerId</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">asPeerId</span><span class="p">.</span><span class="n">Type</span> <span class="k">is</span> <span class="n">not</span> <span class="n">PeerType</span><span class="p">.</span><span class="n">User</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// We only want to reply to messages sent in private chat.</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">await</span> <span class="n">_client</span><span class="p">.</span><span class="n">Api</span><span class="p">.</span><span class="n">CloudChatsApi</span><span class="p">.</span><span class="n">Messages</span><span class="p">.</span><span class="nf">SendMessageAsync</span><span class="p">(</span><span class="n">asPeerId</span><span class="p">,</span> <span class="s">"Hello user. Thank you for contacting me and trying CatraProto!"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The following code checks whether the update is an instance of <code class="language-plaintext highlighter-rouge">UpdateNewMessage</code> and that the Message inside it is an instance of <code class="language-plaintext highlighter-rouge">Message</code> with the <code class="language-plaintext highlighter-rouge">Out</code> property set to false. If the check is successful it makes sure the message was received inside a private chat and then replies to the user.</p> <h2 id="avoiding-older-messages"> <a href="#avoiding-older-messages" class="anchor-heading" aria-labelledby="avoiding-older-messages"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Avoiding older messages </h2> <p>When first logging in, all updates from when the client was created are fetched. This may lead to undesired behaviour as you may not want your bot to start replying to older messages. To mitigate this, you can check the message’s date. Example:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">Date</span> <span class="p">-</span> <span class="n">StartTime</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">_logger</span><span class="p">.</span><span class="nf">Information</span><span class="p">(</span><span class="s">"Skipping message {Id} because it's old."</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Where <code class="language-plaintext highlighter-rouge">StartTime</code> is the unix timestamp value of when you started the script. You can get it by calling <code class="language-plaintext highlighter-rouge">DateTimeOffset.UtcNow.ToUnixTimeSeconds()</code> at startup and saving it in a static field.</p> <h2 id="how-updates-are-delivered"> <a href="#how-updates-are-delivered" class="anchor-heading" aria-labelledby="how-updates-are-delivered"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How updates are delivered </h2> <p>In order to <strong>avoid flooding</strong> the event handler some internal queues are used. There is a queue for each peer and <strong>if an update is not bound to a peer it is added to a common queue</strong>. This means that <strong>each update is separated based on which chat it was sent in</strong> and <strong>it will wait</strong> to trigger your event handler <strong>if an updated from the same chat is still being processed.</strong></p> <p>This behaviour can be disabled through the UpdatesSettings class as described <a href="/library_configuration.md">here</a>.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
